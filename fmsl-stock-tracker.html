<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FMSL Stock Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        .btn-primary {
            @apply bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded;
        }
        .btn-secondary {
            @apply bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold mb-4">FMSL Stock Tracker</h1>

        <!-- Watchlist Management -->
        <div id="watchlist-management" class="mb-6">
            <div class="flex items-center space-x-4">
                <select id="watchlist-select" class="border border-gray-300 rounded-md px-3 py-2 bg-white">
                    <option value="">Select Watchlist</option>
                </select>
                <button id="create-watchlist-btn" class="btn-primary">Create Watchlist</button>
                <button id="delete-watchlist-btn" class="btn-secondary">Delete Watchlist</button>
            </div>
            <input type="text" id="new-watchlist-name" placeholder="New watchlist name" class="mt-2 border border-gray-300 rounded-md px-3 py-2 hidden">
        </div>

        <!-- Ticker Input -->
        <div id="ticker-input-section" class="space-y-3 hidden">
    <div class="flex gap-2">
        <input 
            type="text" 
            id="ticker-input" 
            placeholder="Enter ticker (e.g., AAPL, ITSA3)"
            class="flex-1 border border-gray-300 rounded-md px-3 py-2"
            maxlength="10"
        >
        <select id="market-select" class="border border-gray-300 rounded-md px-3 py-2 bg-white min-w-[120px]">
            <option value="auto">Auto-detect</option>
            <option value="NYSE">NYSE (US)</option>
            <option value="NASDAQ">NASDAQ (US)</option>
            <option value="B3">B3 (Brazil)</option>
            <option value="XETRA">XETRA (Germany)</option>
            <option value="TSE">TSE (Japan)</option>
            <option value="KRX">KRX (Korea)</option>
        </select>
        <button id="add-ticker-btn" class="btn-primary min-w-[100px]">
            <i data-lucide="plus" class="w-4 h-4"></i>
            Add Ticker
        </button>
        <button id="refresh-all-btn" class="btn-secondary min-w-[120px]">
            Refresh All
        </button>
    </div>
    <div class="text-xs text-gray-500">
        ðŸ’¡ Tip: Select the correct market for accurate pricing, or use "Auto-detect" for known tickers
    </div>
</div>

        <!-- Stock List -->
        <div id="stock-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Stock items will be added here -->
        </div>

        <!-- Error Message -->
        <div id="error-message" class="text-red-500 mt-4 hidden"></div>
    </div>

    <script>
        lucide.createIcons();

        let stockData = [];
        let loadingTickers = new Set();

        // Mock Data (replace with actual API calls later)
        const MOCK_COMPANIES = {
            AAPL: { name: "Apple Inc.", market: "NASDAQ", basePrice: 175 },
            GOOGL: { name: "Alphabet Inc.", market: "NASDAQ", basePrice: 2700 },
            MSFT: { name: "Microsoft Corp.", market: "NASDAQ", basePrice: 300 },
            AMZN: { name: "Amazon.com Inc.", market: "NASDAQ", basePrice: 3300 },
            TSLA: { name: "Tesla, Inc.", market: "NASDAQ", basePrice: 700 },
            ITSA3: { name: "ItaÃºsa S.A.", market: "B3", basePrice: 10 },
            VALE3: { name: "Vale S.A.", market: "B3", basePrice: 80 },
            PETR4: { name: "PetrÃ³leo Brasileiro S.A.", market: "B3", basePrice: 30 },
        };

        // Local Storage Management
        function getWatchlists() {
            const watchlists = localStorage.getItem('watchlists');
            return watchlists ? JSON.parse(watchlists) : [];
        }

        function saveWatchlists(watchlists) {
            localStorage.setItem('watchlists', JSON.stringify(watchlists));
        }

        function getCurrentWatchlistName() {
            return localStorage.getItem('currentWatchlistName') || '';
        }

        function setCurrentWatchlistName(name) {
            localStorage.setItem('currentWatchlistName', name);
        }

        function getCurrentWatchlist() {
            const name = getCurrentWatchlistName();
            if (!name) return null;
            const watchlists = getWatchlists();
            return watchlists.find(w => w.name === name) || null;
        }

        function updateCurrentWatchlist(tickers) {
            const name = getCurrentWatchlistName();
            if (!name) return;
            let watchlists = getWatchlists();
            watchlists = watchlists.map(w => {
                if (w.name === name) {
                    return { ...w, tickers: tickers };
                }
                return w;
            });
            saveWatchlists(watchlists);
        }

        // UI Management
        function updateUI() {
            updateWatchlistDropdown();
            updateStockList();
            toggleTickerInputVisibility();
        }

        function updateWatchlistDropdown() {
            const select = document.getElementById('watchlist-select');
            const watchlists = getWatchlists();
            const currentWatchlistName = getCurrentWatchlistName();

            select.innerHTML = '<option value="">Select Watchlist</option>';
            watchlists.forEach(watchlist => {
                const option = document.createElement('option');
                option.value = watchlist.name;
                option.textContent = watchlist.name;
                if (watchlist.name === currentWatchlistName) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        function updateStockList() {
            const stockListDiv = document.getElementById('stock-list');
            stockListDiv.innerHTML = '';

            const currentWatchlist = getCurrentWatchlist();
            if (!currentWatchlist) {
                stockListDiv.innerHTML = '<p class="text-gray-500">No watchlist selected.</p>';
                return;
            }

            if (currentWatchlist.tickers.length === 0) {
                stockListDiv.innerHTML = '<p class="text-gray-500">No tickers in this watchlist. Add some!</p>';
                return;
            }

            currentWatchlist.tickers.forEach(ticker => {
                const stock = stockData.find(s => s.ticker === ticker);
                stockListDiv.appendChild(createStockElement(ticker, stock));
            });
        }

        function createStockElement(ticker, stock) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-md shadow-md p-4 relative';

            if (loadingTickers.has(ticker)) {
                div.innerHTML = `<div class="animate-pulse h-full w-full flex flex-col justify-center items-center">
                                    <i data-lucide="loader-2" class="w-10 h-10 text-gray-500"></i>
                                    <p class="text-gray-500">Loading...</p>
                                 </div>`;
                lucide.createIcons();
                return div;
            }

            if (!stock) {
                div.innerHTML = `<p class="text-gray-500">Failed to load data for ${ticker}</p>`;
                return div;
            }

            const changeClass = stock.change >= 0 ? 'text-green-500' : 'text-red-500';
            const arrowIcon = stock.change >= 0 ? 'arrow-up' : 'arrow-down';

            div.innerHTML = `
                <h2 class="text-lg font-semibold">${stock.name} (${stock.ticker})</h2>
                <p class="text-gray-600">Price: $${stock.price}</p>
                <p class="${changeClass}">
                    <i class="fas fa-${arrowIcon} mr-1"></i>
                    ${stock.change} (${stock.changePercent}%)
                </p>
                <p class="text-gray-500 text-sm">Last Updated: ${stock.lastUpdated}</p>
                <span class="absolute top-2 right-2 text-gray-400 hover:text-red-500 cursor-pointer" onclick="removeTicker('${ticker}')">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </span>
            `;
            lucide.createIcons();
            return div;
        }

        function toggleTickerInputVisibility() {
            const currentWatchlist = getCurrentWatchlist();
            const tickerInputSection = document.getElementById('ticker-input-section');
            tickerInputSection.classList.toggle('hidden', !currentWatchlist);
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 3000);
        }

        // Event Listeners
        document.getElementById('create-watchlist-btn').addEventListener('click', createWatchlist);
        document.getElementById('delete-watchlist-btn').addEventListener('click', deleteWatchlist);
        document.getElementById('watchlist-select').addEventListener('change', selectWatchlist);
        document.getElementById('add-ticker-btn').addEventListener('click', addTicker);
        document.getElementById('refresh-all-btn').addEventListener('click', refreshAllStocks);

        // Watchlist Management Functions
        function createWatchlist() {
            const newWatchlistNameInput = document.getElementById('new-watchlist-name');
            newWatchlistNameInput.classList.remove('hidden');
            newWatchlistNameInput.focus();

            newWatchlistNameInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    const name = newWatchlistNameInput.value.trim();
                    if (name) {
                        const watchlists = getWatchlists();
                        if (watchlists.find(w => w.name === name)) {
                            showError('Watchlist name already exists');
                            return;
                        }
                        watchlists.push({ name: name, tickers: [] });
                        saveWatchlists(watchlists);
                        newWatchlistNameInput.value = '';
                        newWatchlistNameInput.classList.add('hidden');
                        updateUI();
                    } else {
                        showError('Watchlist name cannot be empty');
                    }
                }
            }, { once: true }); // Remove the event listener after it's used once
        }

        function deleteWatchlist() {
            const selectedWatchlistName = document.getElementById('watchlist-select').value;
            if (!selectedWatchlistName) {
                showError('No watchlist selected to delete');
                return;
            }

            if (confirm(`Are you sure you want to delete "${selectedWatchlistName}"?`)) {
                let watchlists = getWatchlists();
                watchlists = watchlists.filter(w => w.name !== selectedWatchlistName);
                saveWatchlists(watchlists);
                setCurrentWatchlistName('');
                stockData = []; // Clear stock data
                updateUI();
            }
        }

        function selectWatchlist() {
            const selectedWatchlistName = document.getElementById('watchlist-select').value;
            setCurrentWatchlistName(selectedWatchlistName);
            stockData = []; // Clear existing stock data when selecting a new watchlist
            const currentWatchlist = getCurrentWatchlist();
            if (currentWatchlist) {
                currentWatchlist.tickers.forEach(ticker => fetchStock(ticker));
            }
            updateUI();
        }

        // Stock Management Functions
        async function addTicker() {
    const input = document.getElementById('ticker-input');
    const marketSelect = document.getElementById('market-select');
    const ticker = input.value.trim().toUpperCase();
    const selectedMarket = marketSelect.value;

    if (!ticker) {
        showError('Please enter a ticker symbol');
        return;
    }

    const currentWatchlist = getCurrentWatchlist();
    if (!currentWatchlist) {
        showError('Please create or select a watchlist first');
        return;
    }

    if (!/^[A-Z0-9.]+$/.test(ticker)) {
        showError('Ticker should only contain letters, numbers, and dots');
        return;
    }

    if (currentWatchlist.tickers.length >= 50) {
        showError('Maximum 50 tickers allowed per watchlist');
        return;
    }

    if (currentWatchlist.tickers.includes(ticker)) {
        showError('Ticker already added to this watchlist');
        return;
    }

    const updatedTickers = [...currentWatchlist.tickers, ticker];
    updateCurrentWatchlist(updatedTickers);
    input.value = '';
    marketSelect.value = 'auto'; // Reset to auto-detect
    updateUI();

    // Fetch stock data with selected market
    await fetchStock(ticker, selectedMarket === 'auto' ? null : selectedMarket);
}

        async function removeTicker(ticker) {
            const currentWatchlist = getCurrentWatchlist();
            if (!currentWatchlist) return;

            const updatedTickers = currentWatchlist.tickers.filter(t => t !== ticker);
            updateCurrentWatchlist(updatedTickers);
            stockData = stockData.filter(s => s.ticker !== ticker); // Remove from stockData
            updateUI();
        }

        async function refreshAllStocks() {
            const currentWatchlist = getCurrentWatchlist();
            if (!currentWatchlist) return;

            stockData = []; // Clear existing data
            for (const ticker of currentWatchlist.tickers) {
                await fetchStock(ticker);
            }
            updateUI();
        }

        async function fetchStock(ticker, forcedMarket = null) {
    loadingTickers.add(ticker);
    updateUI();

    try {
        const data = await simulateApiCall(ticker, forcedMarket);
        stockData = stockData.filter(s => s.ticker !== ticker);
        stockData.push(data);
    } catch (err) {
        showError(`Failed to fetch data for ${ticker}`);
    } finally {
        loadingTickers.delete(ticker);
        updateUI();
    }
}

        function simulateApiCall(ticker, forcedMarket = null) {
    return new Promise((resolve, reject) => {
        const delay = Math.random() * 1500 + 500;
        setTimeout(() => {
            try {
                const data = generateMockStockData(ticker, forcedMarket);
                resolve(data);
            } catch (error) {
                reject(new Error(`Failed to fetch data for ${ticker}`));
            }
        }, delay);
    });
}

        function generateMockStockData(ticker, forcedMarket = null) {
    const upperTicker = ticker.toUpperCase();
    let company = MOCK_COMPANIES[upperTicker];
    
    // If not found in our database and no forced market, try to auto-detect
    if (!company && !forcedMarket) {
        company = autoDetectMarket(upperTicker);
    } else if (!company) {
        // Use forced market with default values
        company = {
            name: `${upperTicker} Corporation`,
            market: forcedMarket,
            basePrice: getDefaultPriceForMarket(forcedMarket),
        };
    } else if (forcedMarket && forcedMarket !== 'auto') {
        // Override the market if user specified one
        company = { ...company, market: forcedMarket };
    }

    const volatility = Math.random() * 0.1 - 0.05; // -5% to +5%
    const price = company.basePrice * (1 + volatility);
    const change = price - company.basePrice;
    const changePercent = (change / company.basePrice) * 100;

    return {
        ticker: upperTicker,
        name: company.name,
        price: Number(price.toFixed(2)),
        change: Number(change.toFixed(2)),
        changePercent: Number(changePercent.toFixed(2)),
        market: company.market,
        lastUpdated: new Date().toLocaleTimeString(),
    };
}

// Auto-detect market based on ticker patterns
function autoDetectMarket(ticker) {
    // Brazilian stocks typically end with numbers
    if (/\d$/.test(ticker)) {
        return {
            name: `${ticker} S.A.`,
            market: 'B3',
            basePrice: Math.random() * 50 + 5, // R$5-55 range
        };
    }
    
    // German stocks often have .DE suffix
    if (ticker.includes('.DE')) {
        return {
            name: `${ticker.replace('.DE', '')} AG`,
            market: 'XETRA',
            basePrice: Math.random() * 200 + 50, // â‚¬50-250 range
        };
    }
    
    // Japanese stocks often have .T suffix
    if (ticker.includes('.T')) {
        return {
            name: `${ticker.replace('.T', '')} Corp`,
            market: 'TSE',
            basePrice: Math.random() * 5000 + 1000, // Â¥1000-6000 range
        };
    }
    
    // Korean stocks often have .KS suffix
    if (ticker.includes('.KS')) {
        return {
            name: `${ticker.replace('.KS', '')} Co Ltd`,
            market: 'KRX',
            basePrice: Math.random() * 100000 + 10000, // â‚©10000-110000 range
        };
    }
    
    // Default to NYSE for unknown tickers
    return {
        name: `${ticker} Corporation`,
        market: 'NYSE',
        basePrice: Math.random() * 300 + 50, // $50-350 range
    };
}

function getDefaultPriceForMarket(market) {
    switch (market) {
        case 'B3':
            return Math.random() * 50 + 5; // R$5-55
        case 'XETRA':
            return Math.random() * 200 + 50; // â‚¬50-250
        case 'TSE':
            return Math.random() * 5000 + 1000; // Â¥1000-6000
        case 'KRX':
            return Math.random() * 100000 + 10000; // â‚©10000-110000
        default:
            return Math.random() * 300 + 50; // $50-350
    }
}

        // Initial Load
        updateUI();
    </script>
</body>
</html>
